<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <canvas id="screen" width="500" height="500"></canvas>

    <script>
      const screen = document.getElementById("screen");
      const context = screen.getContext("2d");
      const currentPlayerId = "player1";

      function createGame() {
        const state = {
          players: {},
          fruts: {}
        };

        function addPlayer(command){
            const playerId = command.playerId
            const playerX = command.playerX
            const playerY = command.playerY
            
            state.players[playerId] = {
                x: playerX,
                y: playerY
            }
        }

        function removePlayer(command){
            const playerId = command.playerId
            delete state.players[playerId]
        }


        function addFrut(command){
            const frutId = command.frutId
            const frutX = command.frutX
            const frutY = command.frutY
            
            state.fruts[frutId] = {
                x: frutX,
                y: frutY
            }
        }

        function removeFrut(command){
            const frutId = command.frutId
            delete state.fruts[frutId]
        }


        function movePlayer(command) {
          console.log(`game.movePlayer() => moving ${command.playerId} with ${command.keyPressed}`);

          const acceptedMoves = {
            ArrowUp(player){
                console.log('moving player Up')
                if (player.x - 1 >= 0) {
                    player.y -= 1;
                }
            },
            ArrowDown(player){
                console.log('moving player Down')
                if (player.x + 1 < screen.width) {
                    player.x += 1;
                }
            },
            ArrowRight(player){
                console.log('moving player Right')
                if (player.y + 1 < screen.width) {
                    player.y += 1;
                }
            },
            ArrowLeft(player){
                console.log('moving player Left')
                if (player.x - 1 >= 0) {
                    player.x -= 1;
                }
            }
          }

          const keyPressed = command.keyPressed;
          const playerId = command.playerId
          const player = state.players[playerId];
          const moveFunction = acceptedMoves[keyPressed]

          if (player && moveFunction){
            moveFunction(player)
            checkForFrutCollision(playerId)
          }
        }

        function checkForFrutCollision(playerId) {
            const player = state.players[playerId]

            for(const frutId in state.fruts){
                const frut = state.fruts[frutId]
                console.log(`checking ${playerId} and ${frutId}`)

                if(player.x === frut.x && player.y === frut.y){
                    console.log('collision')
                    removeFrut({frutId})
                }
            }
        }

        return {
          movePlayer,
          addPlayer,
          removePlayer,
          addFrut,
          removeFrut,
          state
        }
      }

      const game = createGame();
      const keyBoardListener = createKetboardListener();
      keyBoardListener.subscribe(game.movePlayer);

      game.addFrut({frutId: 'frut1', frutX: 1, frutY: 0})
      game.addPlayer({playerId: 'player1', playerX: 0, playerY: 0})

      game.addFrut({frutId: 'frut2', frutX: 10, frutY: 10})
      game.addPlayer({playerId: 'player2', playerX: 10, playerY: 15})

      function createKetboardListener() {
        const state = {
          observers: [],
        };

        function subscribe(observerFunction) {
          state.observers.push(observerFunction);
        }

        function notifyAll(command) {
          console.log(`KeyBoardListener => Notiflying ${state.observers.length} observers`);

          for (const observersFunction of state.observers) {
            observersFunction(command);
          }
        }

        document.addEventListener("keydown", handleKeydown);

        function handleKeydown(event) {
          const keyPressed = event.key;

          const command = {
            playerId: "player1",
            keyPressed,
          };

          notifyAll(command);
        }

        return {
          subscribe,
        };
      }

      renderScreen();

      function renderScreen() {
        context.fillStyle = "white";
        context.clearRect(0, 0, 10, 10);

        for (const playerId in game.players) {
          const player = game.state.players[playerId];
          context.fillStyle = "black";
          context.fillRect(player.x, player.y, 1, 1);
        }

        for (const frutId in game.fruts) {
          const frut = game.state.fruts[frutId];
          context.fillStyle = "green";
          context.fillRect(frut.x, frut.y, 1, 1);
        }

        requestAnimationFrame(renderScreen);
      }
    </script>
  </body>
</html>
